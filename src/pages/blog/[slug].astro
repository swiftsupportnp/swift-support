---
export const prerender = true;
import BaseLayout from "../../layouts/BaseLayout.astro";
import { client } from "../../lib/sanity";
import { POST_BY_SLUG_QUERY, ALL_POST_SLUGS_QUERY } from "../../lib/queries";
import RichText from "../../components/RichText";

export async function getStaticPaths() {
    const posts = await client.fetch(ALL_POST_SLUGS_QUERY);
    return posts.map((p: { slug: string }) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const post = await client.fetch(POST_BY_SLUG_QUERY, { slug });

if (!post) {
    return Astro.redirect("/blog");
}

const seoTitle = post.seo?.title ?? post.title;
const seoDescription = post.seo?.description ?? post.excerpt;
const seoImage = post.seo?.ogImage?.asset?.url ?? post.mainImage?.asset?.url;

const publishedDate = new Date(post.publishedAt).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
});

const toc =
    post.body
        ?.filter(
            (block: any) =>
                block._type === "block" &&
                (block.style === "h2" || block.style === "h3"),
        )
        .map((block: any) => {
            const text = block.children?.map((c: any) => c.text).join("") || "";
            const slugify = (str: string) =>
                str
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, "-")
                    .replace(/(^-|-$)+/g, "");
            return {
                text,
                id: slugify(text),
                level: block.style === "h2" ? 2 : 3,
            };
        }) || [];
---

<BaseLayout
    title={seoTitle}
    description={seoDescription}
    image={seoImage}
    preloadImage={seoImage}
    type="article"
    canonicalUrl={post.seo?.canonicalUrl || Astro.url.href}
>
    <!-- Breadcrumb -->
    <nav class="bg-white border-b border-slate-100" aria-label="Breadcrumb">
        <div class="container py-3">
            <ol
                class="flex items-center space-x-2 text-xs text-slate-500"
                itemscope
                itemtype="https://schema.org/BreadcrumbList"
            >
                <li
                    itemprop="itemListElement"
                    itemscope
                    itemtype="https://schema.org/ListItem"
                >
                    <a href="/" itemprop="item" class="hover:text-brand-700"
                        ><span itemprop="name">Home</span></a
                    >
                    <meta itemprop="position" content="1" />
                </li>
                <li><span class="text-slate-300">/</span></li>
                <li
                    itemprop="itemListElement"
                    itemscope
                    itemtype="https://schema.org/ListItem"
                >
                    <a href="/blog" itemprop="item" class="hover:text-brand-700"
                        ><span itemprop="name">Blog</span></a
                    >
                    <meta itemprop="position" content="2" />
                </li>
                <li><span class="text-slate-300">/</span></li>
                <li
                    class="text-slate-700 font-medium truncate max-w-md"
                    itemprop="itemListElement"
                    itemscope
                    itemtype="https://schema.org/ListItem"
                >
                    <span itemprop="name">{post.title}</span>
                    <meta itemprop="position" content="3" />
                </li>
            </ol>
        </div>
    </nav>

    <!-- Article -->
    <article
        class="bg-white"
        itemscope
        itemtype="https://schema.org/BlogPosting"
    >
        <!-- Hero Image -->
        {
            post.mainImage?.asset?.url && (
                <div class="w-full bg-slate-100">
                    <div class="container py-0">
                        <img
                            src={
                                post.mainImage.asset.url +
                                "?w=1200&h=600&fit=crop&auto=format"
                            }
                            alt={post.mainImage.alt ?? post.title}
                            class="w-full max-h-96 object-cover rounded-b-3xl"
                            width="1200"
                            height="600"
                            itemprop="image"
                        />
                    </div>
                </div>
            )
        }

        <div class="container py-12">
            <div class="grid lg:grid-cols-12 gap-12">
                <!-- Main Article Content -->
                <div class="lg:col-span-8">
                    <!-- Category badges -->
                    {
                        post.categories?.length > 0 && (
                            <div class="flex flex-wrap gap-2 mb-4">
                                {post.categories.map((cat: any) => (
                                    <span class="badge bg-brand-50 text-brand-700">
                                        {cat.title}
                                    </span>
                                ))}
                            </div>
                        )
                    }

                    <!-- Title -->
                    <h1
                        class="text-3xl sm:text-4xl font-bold text-slate-900 leading-tight mb-5"
                        itemprop="headline"
                    >
                        {post.title}
                    </h1>

                    <!-- Meta Info -->
                    <div
                        class="flex flex-wrap items-center gap-4 text-sm text-slate-500 pb-6 border-b border-slate-100 mb-8"
                    >
                        {
                            post.author && (
                                <div class="flex items-center space-x-2.5">
                                    <div class="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-xs font-semibold text-brand-700 flex-shrink-0">
                                        {post.author.name?.[0]}
                                    </div>
                                    <span
                                        itemprop="author"
                                        itemscope
                                        itemtype="https://schema.org/Person"
                                    >
                                        <a
                                            href="/author/swift-support-team"
                                            class="hover:text-brand-700 transition-colors"
                                        >
                                            <span itemprop="name">
                                                Swift Support Team
                                            </span>
                                        </a>
                                    </span>
                                </div>
                            )
                        }
                        <time
                            itemprop="datePublished"
                            datetime={post.publishedAt}>{publishedDate}</time
                        >
                        {
                            post.readingTime && (
                                <span>{post.readingTime} min read</span>
                            )
                        }
                    </div>

                    {
                        post.excerpt && (
                            <p
                                class="text-lg text-slate-600 leading-relaxed mb-8 font-medium"
                                itemprop="description"
                            >
                                {post.excerpt}
                            </p>
                        )
                    }

                    <!-- Table of Contents -->
                    {
                        toc.length > 0 && (
                            <div class="bg-slate-50 border border-slate-100 rounded-2xl p-6 mb-10">
                                <h3 class="text-lg font-bold text-slate-900 mb-4">
                                    Table of Contents
                                </h3>
                                <ul class="space-y-2.5">
                                    {toc.map((item: any) => (
                                        <li
                                            class={
                                                item.level === 3
                                                    ? "ml-5 list-disc list-inside text-slate-400"
                                                    : ""
                                            }
                                        >
                                            <a
                                                href={`#${item.id}`}
                                                class="text-brand-600 hover:text-brand-800 text-sm font-medium transition-colors"
                                            >
                                                {item.text}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )
                    }

                    <!-- Body -->
                    <div class="mt-8 mb-12" itemprop="articleBody">
                        {
                            !post.body ? (
                                <p class="text-slate-500 italic">
                                    Content is being prepared.
                                </p>
                            ) : (
                                <RichText
                                    value={post.body}
                                    isBlog={true}
                                    client:load
                                />
                            )
                        }
                    </div>

                    <!-- Author Bio -->
                    {
                        post.author?.bio && (
                            <div class="mt-10 pt-8 border-t border-slate-100 flex items-start space-x-4">
                                <div class="w-12 h-12 rounded-full bg-brand-100 flex items-center justify-center text-lg font-bold text-brand-700 flex-shrink-0">
                                    {post.author.name?.[0]}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-slate-900">
                                        <a
                                            href="/author/swift-support-team"
                                            class="hover:text-brand-700 transition-colors"
                                        >
                                            Swift Support Team
                                        </a>
                                    </h3>
                                    {post.author.role && (
                                        <p class="text-xs text-brand-600 mb-1.5">
                                            {post.author.role}
                                        </p>
                                    )}
                                    <p class="text-sm text-slate-500 leading-relaxed">
                                        {post.author.bio}
                                    </p>
                                </div>
                            </div>
                        )
                    }
                </div>

                <!-- Sticky Sidebar -->
                <aside class="lg:col-span-4">
                    <div class="sticky top-24 space-y-5">
                        <!-- CTA Card -->
                        <div class="bg-brand-900 rounded-2xl p-6 text-white">
                            <h3 class="font-bold text-base mb-2">
                                Need Expert Help?
                            </h3>
                            <p
                                class="text-brand-200 text-sm mb-4 leading-relaxed"
                            >
                                Our team is ready to help you apply these ideas
                                to your business.
                            </p>
                            <a
                                href="/contact"
                                class="btn-primary bg-white text-brand-900 hover:bg-slate-100 text-sm w-full text-center block"
                            >
                                Talk to Our Team
                            </a>
                        </div>

                        <!-- Related Services -->
                        <div class="card p-5">
                            <h3 class="font-semibold text-slate-900 mb-4">
                                Related Services
                            </h3>
                            <ul class="space-y-2">
                                {
                                    [
                                        {
                                            label: "IT Support",
                                            href: "/services/it-support-maintenance",
                                        },
                                        {
                                            label: "Digital Marketing",
                                            href: "/services/digital-marketing",
                                        },
                                        {
                                            label: "Software Development",
                                            href: "/services/software-development",
                                        },
                                    ].map((s) => (
                                        <li>
                                            <a
                                                href={s.href}
                                                class="flex items-center justify-between text-sm text-slate-600 hover:text-brand-700 py-1 transition-colors"
                                            >
                                                <span>{s.label}</span>
                                                <svg
                                                    class="w-3.5 h-3.5 text-slate-300"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M9 5l7 7-7 7"
                                                    />
                                                </svg>
                                            </a>
                                        </li>
                                    ))
                                }
                            </ul>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </article>

    <!-- Back to blog -->
    <section class="bg-slate-50 py-10">
        <div class="container text-center">
            <a href="/blog" class="btn-secondary text-sm">
                Back to All Articles
            </a>
        </div>
    </section>

    <script
        type="application/ld+json"
        set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "BlogPosting",
            headline: post.title,
            description: seoDescription,
            datePublished: post.publishedAt,
            image: seoImage,
            author: post.author
                ? {
                      "@type": "Person",
                      name: post.author.name,
                  }
                : undefined,
            publisher: {
                "@type": "Organization",
                name: "Swift Support Nepal",
            },
        })}
    />
</BaseLayout>
